<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IMAGE GALLERY </title>
  <!-- Font Awesome 6 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <!-- Google Font: Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* ----- EXACT HEADER â€“ CONTAINER, CENTERED, LIGHT THEME ----- */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #ffffff;
      --bg-secondary: #f8f9fa;
      --text-primary: #1a1a1a;
      --text-secondary: #666666;
      --accent: #2563eb;
      --accent-hover: #1d4ed8;
      --danger: #dc2626;
      --danger-hover: #b91c1c;
      --border: #e5e7eb;
      --shadow-sm: 0 2px 8px rgba(0,0,0,0.02);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.03);
      --shadow-lg: 0 10px 25px rgba(0,0,0,0.04);
      --radius-md: 12px;
      --radius-lg: 20px;
      --transition: all 0.2s ease;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, sans-serif;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 0 24px;
    }

    header {
      padding: 48px 0 32px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 40px;
      text-align: center;
    }

    .logo {
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--text-secondary);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    h1 {
      font-size: 2.75rem;
      font-weight: 700;
      line-height: 1.1;
      margin-bottom: 16px;
      letter-spacing: -0.02em;
      color: #111;
    }

    .subtitle {
      font-size: 1.125rem;
      color: var(--text-secondary);
      font-weight: 400;
      margin-bottom: 40px;
    }

    .stats {
      display: flex;
      justify-content: center;
      gap: 32px;
      margin-bottom: 48px;  /* increased spacing after removing filter bar */
    }

    .stat-box {
      text-align: center;
      padding: 0 16px;
    }

    .stat-number {
      font-size: 1.875rem;
      font-weight: 700;
      color: var(--text-primary);
      line-height: 1;
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 13px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 500;
    }

    /* no filter controls â€“ only images */

    .masonry-grid {
      columns: 4;
      column-gap: 24px;
      margin-bottom: 64px;
    }

    @media (max-width: 1200px) { .masonry-grid { columns: 3; } }
    @media (max-width: 768px) { .masonry-grid { columns: 2; } }
    @media (max-width: 480px) { .masonry-grid { columns: 1; } }

    .masonry-item {
      break-inside: avoid;
      margin-bottom: 24px;
      position: relative;
      border-radius: 20px;
      overflow: hidden;
      cursor: pointer;
      background: #fafafa;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .masonry-item:hover {
      transform: translateY(-4px);
      box-shadow: 0 20px 30px -10px rgba(0,0,0,0.05);
    }

    .masonry-item img {
      width: 100%;
      height: auto;
      display: block;
      background: #f5f5f5;
    }

    /* image badge â€“ always present */
    .media-badge {
      position: absolute;
      bottom: 14px;
      left: 14px;
      background: rgba(255,255,255,0.7);
      backdrop-filter: blur(6px);
      color: #2c2c2c;
      width: 34px;
      height: 34px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      z-index: 2;
      pointer-events: none;
      border: 0.5px solid rgba(0,0,0,0.03);
      box-shadow: 0 2px 6px rgba(0,0,0,0.02);
    }

    .item-actions {
      position: absolute;
      top: 12px;
      right: 12px;
      display: flex;
      gap: 8px;
      opacity: 0;
      transition: opacity 0.2s ease;
      z-index: 10;
    }

    .masonry-item:hover .item-actions {
      opacity: 1;
    }

    .item-btn {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      transition: all 0.2s;
      background: rgba(255, 255, 255, 0.75);
      backdrop-filter: blur(8px);
      color: #2c2c2c;
      border: 0.5px solid rgba(0,0,0,0.03);
      box-shadow: 0 4px 10px rgba(0,0,0,0.02);
    }

    .item-btn:hover {
      background: rgba(255, 255, 255, 0.95);
      transform: scale(1.05);
      color: #000;
      box-shadow: 0 8px 16px rgba(0,0,0,0.04);
    }

    .delete-item-btn {
      background: rgba(255, 255, 255, 0.75);
      color: #b91c1c;
    }

    .delete-item-btn:hover {
      background: rgba(255, 255, 255, 0.95);
      color: #b91c1c;
    }

    /* ----- MODAL â€“ LIGHT & AIRY, ONLY IMAGE, ARROWS WITH LOADING ----- */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.7);
      backdrop-filter: blur(12px);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .modal-wrapper {
      position: relative;
      max-width: 90vw;
      max-height: 90vh;
      background: white;
      border-radius: 24px;
      box-shadow: 0 30px 60px rgba(0,0,0,0.06);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .modal-media-container {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
    }

    .modal-media {
      display: block;
      max-width: 90vw;
      max-height: 80vh;
      object-fit: contain;
      background: #fff;
    }

    /* ----- ARROW NAVIGATION â€“ WITH LOADING SPINNER STATES ----- */
    .nav-arrow-left,
    .nav-arrow-right {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 60px;
      height: 60px;
      background: rgba(255,255,255,0.8);
      backdrop-filter: blur(10px);
      border: 0.5px solid rgba(0,0,0,0.03);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      color: #2c2c2c;
      cursor: pointer;
      transition: all 0.2s;
      z-index: 1020;
      box-shadow: 0 6px 18px rgba(0,0,0,0.02);
    }
    .nav-arrow-left {
      left: -30px;
    }
    .nav-arrow-right {
      right: -30px;
    }
    .nav-arrow-left:hover,
    .nav-arrow-right:hover {
      background: white;
      transform: translateY(-50%) scale(1.08);
      color: #000;
      box-shadow: 0 12px 24px rgba(0,0,0,0.04);
    }

    /* loading state on arrows â€“ subtle spinner */
    .nav-arrow-left.loading,
    .nav-arrow-right.loading {
      pointer-events: none;
      opacity: 0.9;
    }
    .nav-arrow-left.loading i,
    .nav-arrow-right.loading i {
      display: none;
    }
    .nav-arrow-left.loading::after,
    .nav-arrow-right.loading::after {
      content: '';
      width: 26px;
      height: 26px;
      border: 2px solid rgba(0,0,0,0.05);
      border-radius: 50%;
      border-top-color: #2563eb;
      animation: spin 0.7s linear infinite;
      display: block;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .modal-toolbar {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 12px;
      padding: 14px 24px;
      background: rgba(255,255,255,0.8);
      backdrop-filter: blur(20px);
      border-top: 0.5px solid rgba(0,0,0,0.03);
    }

    .modal-toolbar button {
      background: rgba(255,255,255,0.7);
      border: 0.5px solid rgba(0,0,0,0.03);
      border-radius: 40px;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      color: #2c2c2c;
      font-weight: 500;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.15s;
      backdrop-filter: blur(8px);
    }

    .modal-toolbar button:hover {
      background: rgba(255,255,255,0.95);
    }

    .close-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      width: 44px;
      height: 44px;
      background: rgba(255,255,255,0.7);
      backdrop-filter: blur(10px);
      border: 0.5px solid rgba(0,0,0,0.03);
      color: #2c2c2c;
      font-size: 22px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      z-index: 1010;
    }

    .close-btn:hover {
      background: rgba(255,255,255,0.95);
      transform: rotate(90deg);
    }

    .password-modal {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(255,255,255,0.7);
      backdrop-filter: blur(12px);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }

    .password-box {
      background: white;
      padding: 32px 28px;
      border-radius: 32px;
      width: 380px;
      max-width: 90%;
      box-shadow: 0 30px 60px rgba(0,0,0,0.06);
      border: 0.5px solid rgba(0,0,0,0.02);
    }

    .password-box h3 {
      font-weight: 600;
      margin-bottom: 12px;
      font-size: 1.25rem;
      color: #1a1a1a;
    }

    .password-input {
      width: 100%;
      padding: 14px 18px;
      border: 1px solid #eee;
      border-radius: 50px;
      font-size: 15px;
      margin-bottom: 24px;
      background: #fafafa;
    }

    .password-input:focus {
      outline: none;
      border-color: #2563eb;
      background: white;
    }

    .password-buttons {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .btn {
      padding: 12px 24px;
      border-radius: 50px;
      border: none;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    .btn-cancel {
      background: #f1f1f1;
      color: #333;
    }

    .btn-cancel:hover {
      background: #e5e5e5;
    }

    .btn-delete {
      background: #dc2626;
      color: white;
    }

    .btn-delete:hover {
      background: #b91c1c;
    }

    #passwordError {
      color: #dc2626;
      font-size: 13px;
      margin-top: -10px;
      margin-bottom: 16px;
      display: none;
    }

    footer {
      text-align: center;
      padding: 32px 0;
      border-top: 1px solid var(--border);
      color: var(--text-secondary);
      font-size: 14px;
    }

    .footer-links {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      gap: 8px;
    }

    .footer-links a {
      text-decoration: none;
      color: var(--text-secondary);
      font-weight: 500;
      transition: color 0.2s ease;
    }

    .footer-links a:hover {
      color: var(--text-primary);
    }

    .footer-links span {
      color: var(--text-secondary);
      opacity: 0.4;
    }

    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(20px);
      color: #1a1a1a;
      padding: 12px 28px;
      border-radius: 50px;
      font-size: 14px;
      border: 0.5px solid rgba(0,0,0,0.03);
      box-shadow: 0 10px 30px rgba(0,0,0,0.03);
      z-index: 3000;
      animation: slideUp 0.3s ease;
      font-weight: 500;
    }

    @keyframes slideUp {
      from { transform: translateX(-50%) translateY(20px); opacity: 0; }
      to { transform: translateX(-50%) translateY(0); opacity: 1; }
    }

    .loading {
      text-align: center;
      padding: 80px 0;
      grid-column: 1 / -1;
    }

    .loading-spinner {
      display: inline-block;
      width: 40px;
      height: 40px;
      border: 2px solid #f0f0f0;
      border-radius: 50%;
      border-top-color: #2563eb;
      animation: spin 0.8s ease infinite;
      margin-bottom: 20px;
    }

    .error-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <i class="fas fa-images"></i>
        IMAGE GALLERY
      </div>
      <h1>Kareri 2026 </h1>
      <p class="subtitle">Snow, rivers, roads and everything in between </p>
      <div class="stats">
        <div class="stat-box">
          <div class="stat-number" id="totalCount">0</div>
          <div class="stat-label">Total Images</div>
        </div>
        <div class="stat-box">
          <div class="stat-number" id="imageCount">0</div>
          <div class="stat-label">Images</div>
        </div>
        <!-- video stat completely removed -->
      </div>
    </header>

    <!-- NO FILTER BUTTONS â€“  are displayed anyway -->

    <div class="masonry-grid" id="grid"></div>
    <footer>
      <p class="footer-links">
        <a href="/">Kareri 2026</a>
        <span>â€¢</span>
        <a href="/about-us">About Us</a>
        <span>â€¢</span>
        <a href="/map">Route</a>
        <span>â€¢</span>
        <a href="/dev">About Trip</a>
      </p>
    </footer>
  </div>

  <!-- MODAL â€“ only image, arrow loading intact -->
  <div class="modal" id="modal">
    <div class="modal-wrapper">
      <div class="modal-media-container" style="position: relative;">
        <img id="mImg" class="modal-media" style="display: block;">
        <!-- ARROW NAVIGATION with loading state -->
        <div class="nav-arrow-left" id="navPrev" title="Previous (â†)">
          <i class="fas fa-chevron-left"></i>
        </div>
        <div class="nav-arrow-right" id="navNext" title="Next (â†’)">
          <i class="fas fa-chevron-right"></i>
        </div>
      </div>

      <div class="modal-toolbar">
        <button id="modalShareBtn"><i class="fas fa-link"></i> Share</button>
        <button id="modalDownloadBtn"><i class="fas fa-download"></i> Download</button>
        <button id="modalDeleteBtn"><i class="fas fa-trash-alt"></i> Delete</button>
      </div>
      <button class="close-btn" id="closeModal"><i class="fas fa-times"></i></button>
    </div>
  </div>

  <!-- PASSWORD MODAL (unchanged) -->
  <div class="password-modal" id="passwordModal">
    <div class="password-box">
      <h3><i class="fas fa-lock"></i> Delete Confirmation</h3>
      <p>Enter the admin password to delete this image.</p>
      <input type="password" class="password-input" id="adminPassword" placeholder="Enter admin password">
      <p id="passwordError"><i class="fas fa-exclamation-circle"></i> Incorrect password</p>
      <div class="password-buttons">
        <button class="btn btn-cancel" id="cancelDelete">Cancel</button>
        <button class="btn btn-delete" id="confirmDelete"><i class="fas fa-trash"></i> Delete</button>
      </div>
    </div>
  </div>

  <script>
    // ================================================================
    // GALLERY â€“  (filtered from Cloudinary data)
    // â€“ fetches real data, keeps only items with "/image/upload/"
    // â€“ download adds correct extension based on blob type
    // â€“ filter buttons removed â€“ all shown items are images
    // ================================================================

    // --- PURE IMAGE GALLERY â€“ no video, no media options ---
    let mediaItems = [];        // will contain only image objects
    let mediaToDelete = null;

    let currentModalIndex = -1;
    let currentFilteredList = []; // simply mediaItems, no filter

    const grid = document.getElementById('grid');
    const modal = document.getElementById('modal');
    const mImg = document.getElementById('mImg');
    const closeModalBtn = document.getElementById('closeModal');
    const passwordModal = document.getElementById('passwordModal');
    const adminPassword = document.getElementById('adminPassword');
    const cancelDelete = document.getElementById('cancelDelete');
    const confirmDelete = document.getElementById('confirmDelete');
    const passwordError = document.getElementById('passwordError');
    const totalCount = document.getElementById('totalCount');
    const imageCount = document.getElementById('imageCount');
    const navPrev = document.getElementById('navPrev');
    const navNext = document.getElementById('navNext');

    // ---------- FALLBACK: real image entries from user's Cloudinary data ----------
    const FALLBACK_IMAGES = [
      {
        thumbnail: "https://res.cloudinary.com/dnssyb7hu/image/upload/c_scale,f_auto,q_auto:low,w_400/IMG20260208091305",
        high_quality: "https://res.cloudinary.com/dnssyb7hu/image/upload/c_scale,f_auto,q_auto,w_1280/IMG20260208091305"
      },
      {
        thumbnail: "https://res.cloudinary.com/dnssyb7hu/image/upload/c_scale,f_auto,q_auto:low,w_400/IMG20260208091328",
        high_quality: "https://res.cloudinary.com/dnssyb7hu/image/upload/c_scale,f_auto,q_auto,w_1280/IMG20260208091328"
      },
      {
        thumbnail: "https://res.cloudinary.com/dnssyb7hu/image/upload/c_scale,f_auto,q_auto:low,w_400/IMG20260208091732",
        high_quality: "https://res.cloudinary.com/dnssyb7hu/image/upload/c_scale,f_auto,q_auto,w_1280/IMG20260208091732"
      },
      {
        thumbnail: "https://res.cloudinary.com/dnssyb7hu/image/upload/c_scale,f_auto,q_auto:low,w_400/IMG20260208092447",
        high_quality: "https://res.cloudinary.com/dnssyb7hu/image/upload/c_scale,f_auto,q_auto,w_1280/IMG20260208092447"
      },
      {
        thumbnail: "https://res.cloudinary.com/dnssyb7hu/image/upload/c_scale,f_auto,q_auto:low,w_400/IMG20260208092654",
        high_quality: "https://res.cloudinary.com/dnssyb7hu/image/upload/c_scale,f_auto,q_auto,w_1280/IMG20260208092654"
      },
      {
        thumbnail: "https://res.cloudinary.com/dnssyb7hu/image/upload/c_scale,f_auto,q_auto:low,w_400/IMG20260208092733",
        high_quality: "https://res.cloudinary.com/dnssyb7hu/image/upload/c_scale,f_auto,q_auto,w_1280/IMG20260208092733"
      }
    ];

    // ---------- stats update ----------
    function updateStats() {
      const total = mediaItems.length;
      totalCount.textContent = total;
      imageCount.textContent = total;   // all are images
    }

    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.innerHTML = `<i class="fas fa-check-circle" style="color: #2563eb;"></i> ${message}`;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 2600);
    }

    // ---------- SHARE (copy link) ----------
    window.shareMedia = async function(url) {
      try {
        await navigator.clipboard.writeText(url);
        showToast('ðŸ”— Link copied');
      } catch {
        const ta = document.createElement('textarea');
        ta.value = url;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        showToast('Link copied');
      }
    };

    // ---------- DOWNLOAD â€“ with smart extension from blob type ----------
    window.downloadMedia = async function(url) {
      try {
        const response = await fetch(url);
        const blob = await response.blob();
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);

        // Extract base name from URL (last segment before query)
        let baseName = url.split('/').pop().split('?')[0] || 'image';
        // Remove any .trashed- prefix if present
        baseName = baseName.replace(/^\.trashed-\d+-/, '');

        // Determine extension from blob MIME type
        let extension = '';
        const mime = blob.type;
        if (mime.includes('jpeg') || mime.includes('jpg')) extension = '.jpg';
        else if (mime.includes('png')) extension = '.png';
        else if (mime.includes('gif')) extension = '.gif';
        else if (mime.includes('webp')) extension = '.webp';
        else if (mime.includes('svg')) extension = '.svg';
        else extension = ''; // let browser decide or no extension

        a.download = baseName + extension;
        a.click();
        URL.revokeObjectURL(a.href);
        showToast('Download started');
      } catch {
        showToast('Download failed');
      }
    };

    // ---------- DELETE prompt (unchanged) ----------
    window.deleteMediaPrompt = function(url) {
      mediaToDelete = url;
      passwordModal.style.display = 'flex';
      adminPassword.value = '';
      passwordError.style.display = 'none';
    };

    async function confirmDeleteAction() {
      const pwd = adminPassword.value.trim();
      if (!pwd) {
        passwordError.textContent = 'Password required';
        passwordError.style.display = 'block';
        return;
      }
      try {
        const response = await fetch('/api/media', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password: pwd, url: mediaToDelete })
        });
        if (response.ok) {
          mediaItems = mediaItems.filter(item => item.high_quality !== mediaToDelete);
          render();
          passwordModal.style.display = 'none';
          mediaToDelete = null;
          showToast('Image deleted');
          if (modal.style.display === 'flex' && mImg.src === mediaToDelete) {
            closeModalFunc();
          }
        } else {
          passwordError.textContent = 'Incorrect password';
          passwordError.style.display = 'block';
        }
      } catch {
        passwordError.textContent = 'Network error';
        passwordError.style.display = 'block';
      }
    }

    function cancelDeleteFunc() {
      passwordModal.style.display = 'none';
      mediaToDelete = null;
    }

    // ---------- RENDER â€“ , no filter logic ----------
    function render() {
      if (!mediaItems.length) {
        grid.innerHTML = `<div class="error-state"><i class="fas fa-images" style="color: #aaa;"></i><h3 style="margin-bottom: 12px; font-weight: 400;">No Images Found</h3><p style="color: #999;">Add some images to get started</p></div>`;
        updateStats();
        return;
      }

      let html = '';
      mediaItems.forEach((item) => {
        const thumb = item.thumbnail;
        const high = item.high_quality;

        html += `<div class="masonry-item" data-url="${high}">`;
        html += `<img src="${thumb}" loading="lazy" alt="gallery image">`;
        // always image badge
        html += `<div class="media-badge"><i class="fas fa-image"></i></div>`;
        html += `<div class="item-actions">`;
        html += `<button class="item-btn" onclick="event.stopPropagation(); downloadMedia('${high}')" title="Download"><i class="fas fa-download"></i></button>`;
        html += `<button class="item-btn" onclick="event.stopPropagation(); shareMedia('${high}')" title="Copy link"><i class="fas fa-link"></i></button>`;
        html += `<button class="item-btn delete-item-btn" onclick="event.stopPropagation(); deleteMediaPrompt('${high}')" title="Delete"><i class="fas fa-trash-alt"></i></button>`;
        html += `</div>`;
        html += `</div>`;
      });

      grid.innerHTML = html;

      // attach click to open modal (no video hover effects)
      grid.querySelectorAll('.masonry-item').forEach(el => {
        el.addEventListener('click', (e) => {
          if (e.target.closest('.item-btn')) return;
          const url = el.dataset.url;
          openModal(url);
        });
      });

      updateStats();
    }

    // ---------- MODAL: only image ----------
    function openModal(url) {
      // currentFilteredList is all images (no filter)
      currentFilteredList = mediaItems.slice();
      currentModalIndex = currentFilteredList.findIndex(item => item.high_quality === url);

      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';

      mImg.src = url;
      mImg.style.display = 'block';

      // update toolbar actions for this image
      document.getElementById('modalShareBtn').onclick = (e) => { e.stopPropagation(); shareMedia(url); };
      document.getElementById('modalDownloadBtn').onclick = (e) => { e.stopPropagation(); downloadMedia(url); };
      document.getElementById('modalDeleteBtn').onclick = (e) => {
        e.stopPropagation();
        deleteMediaPrompt(url);
      };
    }

    // ---------- NAVIGATE with loading arrows ----------
    function navigateModal(direction) {
      if (currentFilteredList.length === 0 || currentModalIndex === -1) return;

      const arrow = direction === -1 ? navPrev : navNext;
      arrow.classList.add('loading');

      let newIndex = currentModalIndex + direction;
      if (newIndex < 0) newIndex = currentFilteredList.length - 1;
      if (newIndex >= currentFilteredList.length) newIndex = 0;

      const nextItem = currentFilteredList[newIndex];
      if (!nextItem) {
        arrow.classList.remove('loading');
        return;
      }

      const nextUrl = nextItem.high_quality;
      // preload image before switching
      const tempImg = new Image();
      tempImg.src = nextUrl;
      tempImg.onload = () => {
        currentModalIndex = newIndex;
        mImg.src = nextUrl;
        arrow.classList.remove('loading');

        // update modal buttons for new image
        document.getElementById('modalShareBtn').onclick = (e) => { e.stopPropagation(); shareMedia(nextUrl); };
        document.getElementById('modalDownloadBtn').onclick = (e) => { e.stopPropagation(); downloadMedia(nextUrl); };
        document.getElementById('modalDeleteBtn').onclick = (e) => {
          e.stopPropagation();
          deleteMediaPrompt(nextUrl);
        };
      };
      tempImg.onerror = () => {
        arrow.classList.remove('loading');
        showToast('Failed to load image');
      };
    }

    function closeModalFunc() {
      modal.style.display = 'none';
      document.body.style.overflow = 'auto';
      currentModalIndex = -1;
      currentFilteredList = [];
      navPrev.classList.remove('loading');
      navNext.classList.remove('loading');
    }

    // ---------- LOAD REAL DATA, FILTER  ----------
    async function loadMedia() {
      grid.innerHTML = `<div class="loading"><div class="loading-spinner"></div><p style="color: #999;">Loading images...</p></div>`;

      try {
        const res = await fetch('/api/media');
        if (res.ok) {
          const data = await res.json();
          if (Array.isArray(data)) {
            // STRICT FILTER: keep only items where high_quality contains "/image/upload/"
            mediaItems = data.filter(item =>
              item.high_quality && item.high_quality.includes('/image/upload/')
            );
          } else {
            mediaItems = [];
          }
        } else {
          // fallback to real Cloudinary image entries (no pexels, no videos)
          mediaItems = [...FALLBACK_IMAGES];
        }
      } catch (error) {
        console.warn('Fetch failed, using fallback image set', error);
        mediaItems = [...FALLBACK_IMAGES];
      }

      // If after all we have zero items, keep fallback
      if (mediaItems.length === 0) {
        mediaItems = [...FALLBACK_IMAGES];
      }

      render();
    }

    // ---------- EVENT LISTENERS ----------
    closeModalBtn.addEventListener('click', closeModalFunc);
    modal.addEventListener('click', (e) => { if (e.target === modal) closeModalFunc(); });

    cancelDelete.addEventListener('click', cancelDeleteFunc);
    confirmDelete.addEventListener('click', confirmDeleteAction);
    adminPassword.addEventListener('keypress', (e) => { if (e.key === 'Enter') confirmDeleteAction(); });

    navPrev.addEventListener('click', () => navigateModal(-1));
    navNext.addEventListener('click', () => navigateModal(1));

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (modal.style.display === 'flex') closeModalFunc();
        if (passwordModal.style.display === 'flex') cancelDeleteFunc();
      }
      if (modal.style.display === 'flex') {
        if (e.key === 'ArrowLeft') {
          e.preventDefault();
          navigateModal(-1);
        } else if (e.key === 'ArrowRight') {
          e.preventDefault();
          navigateModal(1);
        }
      }
    });

    // START
    loadMedia();
  </script>
</body>
</html>
